//////////////////////////////////////////////////
// TITLE Resources
//////////////////////////////////////////////////

import static java.io.File.separator


/* SECTION check */

apply from: "$utilitiesDir${separator}meta${separator}application.gradle"
checkApply.call(['evaluateGStringString'])


/* SECTION methods */

project.ext.makeResourcesTasks = { Closure c ->
    tasks.withType(ProcessResources) { ProcessResources t ->
        String taskSourceSetName = name.replace('process', '').replace('Resources', ''),
               sourceSetName = (taskSourceSetName.empty ? 'main' : taskSourceSetName).uncapitalize()

        t.configure {
            configure c

            Map<String, Object> e = inputs.properties.findAll { it.key.startsWith 'expand_' }.collectEntries { [it.key.replace('expand_', ''), it.value] } as Map<String, Object>

            // COMMENT replace stuff in the to-be-processed files, nothing else
            rename ~/(.*)\.in/, '$1'
            from(sourceSets."$sourceSetName".resources.srcDirs) {
                include '**/*.in'

                // COMMENT replace variables
                expand e
            }

            // COMMENT copy everything else except the processed files
            from(sourceSets."$sourceSetName".resources.srcDirs) {
                exclude '**/*.in'
            }

            Binding eb = new Binding(e)
            eachFile { it.path = evaluateGStringString.call it.path, eb }
        }
    }
}
